package net.qmdboss.payment;

import com.hnapay.gateway.client.enums.CharsetTypeEnum;
import com.hnapay.gateway.client.java.ClientSignature;
import net.qmdboss.bean.QueryDetailsXszf;
import net.qmdboss.entity.RechargeConfig;
import net.qmdboss.entity.UserAccountRecharge;
import net.qmdboss.util.CommonUtil;

import java.io.IOException;
import java.math.BigDecimal;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Map;
import java.util.StringTokenizer;

/**
 * 新生支付
 * @author Xsf
 *
 */
public class HnapayUtils {
	public static Map<String,String> resMap = new HashMap<String,String>();
	
	static{
		resMap.put("0", "已接受");
		resMap.put("1", "处理中");
		resMap.put("2", "处理成功 ");
		resMap.put("3", "处理失败");
	}
	public String getExamineVerify(RechargeConfig rechargeConfig,UserAccountRecharge userAccountRecharge,Map<String,String> map){
		StringBuffer sb = new StringBuffer();
		String orderId="";//订单号
		String beginTime="";//查询开始时间
		String endTime="";//查询结束时间
		String remark="fy";//扩展字段
		String mode="2";
		String serialID=CommonUtil.PR + CommonUtil.getRandomString(15);
		if(userAccountRecharge!=null){
			orderId = userAccountRecharge.getTradeNo();
			mode="1";
//			remark = "查询订单号为"+orderId+"的充值结果";
		}
		if(map!=null){
			beginTime=map.get("beginTime");
			endTime=map.get("endTime");
//			remark="查询从"+beginTime+"到"+endTime+"的充值结果集";
		}
		String signType="2";
		sb.append("version=2.6");
		sb.append("&serialID="+serialID);
		sb.append("&mode="+mode);//商户选择查询模式：         1：单笔         2：批量 
		sb.append("&type=1");//商户选择查询类型：         1：支付订单         2：退款订单 
		sb.append("&orderID="+orderId);
		sb.append("&beginTime="+beginTime);
		sb.append("&endTime="+endTime);
		sb.append("&partnerID="+rechargeConfig.getBargainorId());
		sb.append("&remark="+remark);
		sb.append("&charset=1");
		sb.append("&signType="+signType);
		String signMsg = sb.toString();
		System.out.println("signMsg="+signMsg);
		 if(signType.equals("2")){
				 //测试pKey
				String pkey = rechargeConfig.getBargainorKey();// "30819f300d06092a864886f70d010101050003818d0030818902818100af48db8f2aa0f029aa3fadfcf749267566544d2ce25738df295d94bb918542421f2b649e533db53553a3e9a4bd860068b759af4681d96f4732e47b4653b93339e68b7ef00e2cef3ab8ec5e9c65d4c7992f626c1f4b9a95a626d005fce59919ae1b619748194256ec4627a932d75b8f9fb51c3a78bfbc53bcc0bbb4924d59c6310203010001";
				signMsg = signMsg+"&pkey="+pkey;
			    try {
			    	signMsg = ClientSignature.genSignByMD5(signMsg, CharsetTypeEnum.UTF8);
				} catch (Exception e) {
					e.printStackTrace();
				}
		   }else if(signType.equals("1")){
//			   RSA：网关公钥钥解签
			   try {
				   signMsg = ClientSignature.genSignByRSA(signMsg, CharsetTypeEnum.UTF8);
				} catch (Exception e) {
					e.printStackTrace();
				}
		   }
		   
		sb.append("&signMsg="+signMsg);
		String str="";
		try {
			str = CommonUtil.getHtml(CommonUtil.XSZF_WEB+"/website/queryOrderResult.htm?"+sb.toString(), "tudou");
			System.out.println("str=="+str);
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		return str;
	}
	
	/**
	 * 检验批量查询字符串
	 * @return
	 * @throws ParseException 
	 */
	public Map<String,Object> verifyStr(String str){
//		String s="serialID=1364784637850&mode=2&type=1&resultCode=0000&queryDetailsSize=166&queryDetails=20130321100322319057,1,1,20130321020306,20130321020400,1051303210203018213,2|20130321100934393814,1,1,20130321020918,20130321021007,1051303210209018214,2|20130321115602412476,1,1,20130321035546,20130321035608,1051303210355018216,2|20130321120446563411,1,1,20130321040430,20130321040452,1051303210404018217,2|2013032112051767167,1,1,20130321040501,20130321040518,1051303210405018218,2|H120130321211938,10000,10000,20130321131936,20130321132027,1051303211320018223,2|H120130321212458,10000,10000,20130321132456,20130321132515,1051303211325018224,2|H120130321212744,10000,10000,20130321132742,20130321132819,1051303211328018225,2|H120130321221719,10000,10000,20130321141717,20130321141734,1051303211417018226,2|H120130321221905,10000,10000,20130321141903,20130321141920,1051303211419018227,2|20130322140600496828,1,1,20130322060547,20130322060757,1051303220606018228,2|2013032214090265369,1,1,20130322060847,20130322060944,1051303220609018229,2|20130322141253462791,1,1,20130322061238,20130322061252,1051303220612018230,2|20130322141809434314,1,1,20130322061755,20130322061850,1051303220618018231,2|20130322144429729446,400,400,20130322064414,20130322064430,1051303220644018232,2|20130322150146914260,300,300,20130322070131,20130322070147,1051303220701018233,2|20130322150336878975,200,200,20130322070321,20130322070341,1051303220703018234,2|20130322150935701857,100,100,20130322070920,20130322070931,1051303220709018235,2|20130322152101422885,700,700,20130322072046,20130322072057,1051303220720018236,2|20130322153103876090,300,300,20130322073049,20130322073104,1051303220731018237,2|2013032215545947225,200,200,20130322075445,20130322075459,1051303220754018238,2|20130322160852295681,100,100,20130322080837,20130322080850,1051303220808018239,2|20130322163155685575,100,100,20130322083141,20130322083153,1051303220831018240,2|20130322163329689160,900,900,20130322083314,20130322083327,1051303220833018241,2|20130322171024272031,200,200,20130322091009,20130322091022,1051303220910018243,2|20130322171535854075,100,100,20130322091520,20130322091536,1051303220915018244,2|20130322171811522534,100,100,20130322091756,20130322091805,1051303220918018245,2|2013032217202257907,500,500,20130322092007,20130322092047,1051303220920018246,2|20130322175732917160,200,200,20130322095717,20130322095832,1051303220958018247,2|20130322193418283243,100,100,20130322113403,20130322113416,1051303221134018248,2|20130322194114674336,200,200,20130322114059,20130322114110,1051303221141018249,2|20130322194332514831,300,300,20130322114319,20130322114328,1051303221143018250,2|20130322194531840776,100,100,20130322114516,20130322114528,1051303221145018251,2|20130322194730796933,500,500,20130322114716,20130322114726,1051303221147018252,2|20130323091852647854,200,200,20130323011838,20130323011852,1051303230118018253,2|20130323093003600486,100,100,20130323012952,20130323013012,1051303230130018254,2|20130323093334764059,200,200,20130323013321,20130323013334,1051303230133018255,2|20130323094154890324,300,300,20130323014140,20130323014152,1051303230141018256,2|20130323095137115922,400,400,20130323015124,20130323015138,1051303230151018257,2|20130323095840500007,400,400,20130323015827,20130323015836,1051303230158018258,2|20130323100120572568,200,200,20130323020106,20130323020116,1051303230201018259,2|20130323133904849018,100,100,20130323053850,20130323053911,1051303230539018260,2|20130323134236430867,200,200,20130323054222,20130323054232,1051303230542018261,2|20130323144426433966,500,500,20130323064413,20130323064425,1051303230644018262,2|20130323144829514179,200,200,20130323064815,20130323064826,1051303230648018263,2|2013032314501378949,300,300,20130323064959,20130323065012,1051303230650018264,2|20130323145822650542,500,500,20130323065808,20130323065827,1051303230658018265,2|20130323153010359922,200,200,20130323072956,20130323073005,1051303230730018266,2|20130323153302369150,200,200,20130323073248,20130323073256,1051303230732018267,2|20130323153706715683,100,100,20130323073652,20130323073701,1051303230736018268,2|20130323154218951526,300,300,20130323074204,20130323074214,1051303230742018269,2|20130323154306576701,200,200,20130323074252,20130323074301,1051303230742018270,2|20130323154839361551,100,100,20130323074825,20130323074836,1051303230748018271,2|20130323155033536411,200,200,20130323075019,20130323075029,1051303230750018272,2|20130323155247755835,400,400,20130323075233,20130323075243,1051303230752018273,2|20130323181640857999,500,500,20130323101627,20130323101722,1051303231017018274,2|20130323183433973856,200,200,20130323103419,20130323103429,1051303231034018275,2|20130323183629516621,300,300,20130323103615,20130323103624,1051303231036018276,2|20130323184626605467,100,100,20130323104612,20130323104621,1051303231046018277,2|20130323184835610735,100,100,20130323104820,20130323104834,1051303231048018278,2|20130323185550412351,400,400,20130323105536,20130323105545,1051303231055018279,2|20130323185752260235,200,200,20130323105738,20130323105749,1051303231057018280,2|201303231859029408,200,200,20130323105848,20130323105858,1051303231058018281,2|20130323190217549342,100,100,20130323110203,20130323110211,1051303231102018282,2|20130323190347887775,200,200,20130323110333,20130323110342,1051303231103018283,2|20130323190513187434,400,400,20130323110459,20130323110508,1051303231105018284,2|20130323190636549574,100,100,20130323110622,20130323110630,1051303231106018285,2|20130323190934924230,200,200,20130323110919,20130323110927,1051303231109018286,2|20130323191246528741,300,300,20130323111232,20130323111241,1051303231112018287,2|20130323192357880531,100,100,20130323112343,20130323112351,1051303231123018288,2|20130323192537493643,100,100,20130323112523,20130323112531,1051303231125018289,2|20130323192719842403,200,200,20130323112705,20130323112714,1051303231127018290,2|20130323194503804896,100,100,20130323114449,20130323114457,1051303231144018291,2|20130323194836479909,100,100,20130323114822,20130323114841,1051303231148018292,2|20130323195054161584,200,200,20130323115040,20130323115048,1051303231150018293,2|2013032319515785518,100,100,20130323115143,20130323115151,1051303231151018294,2|20130325092503654532,100,100,20130325012501,20130325012512,1051303250125018295,2|2013032509492078484,200,200,20130325014910,20130325014922,1051303250149018296,2|20130325100838132512,300,300,20130325020836,20130325020846,1051303250208018298,2|20130325103454527550,400,400,20130325023441,20130325023451,1051303250234018300,2|20130325112755286032,200,200,20130325032744,20130325032806,1051303250328018301,2|2013032511463879913,100,100,20130325034626,20130325034710,1051303250347018302,2|20130325114948430238,200,200,20130325034936,20130325034947,1051303250349018303,2|20130325115254977582,200,200,20130325035242,20130325035250,1051303250352018304,2|2013032511573638740,200,200,20130325035724,20130325035733,1051303250357018305,2|2013032512003559945,200,200,20130325040025,20130325040034,1051303250400018306,2|20130325122501179790,100,100,20130325042456,20130325042505,1051303250425018307,2|20130325122655552040,100,100,20130325042644,20130325042658,1051303250426018308,2|2013032512285410744,300,300,20130325042842,20130325042852,1051303250428018309,2|20130325123031197277,100,100,20130325043020,20130325043030,1051303250430018310,2|20130325123329107361,100,100,20130325043316,20130325043327,1051303250433018311,2|2013032512350930210,300,300,20130325043457,20130325043507,1051303250435018312,2|20130325123636313998,200,200,20130325043624,20130325043632,1051303250436018313,2|20130325123857435436,200,200,20130325043845,20130325043855,1051303250438018314,2|20130325134935845826,300,300,20130325054935,20130325054952,1051303250549018315,2|20130325135140769173,100,100,20130325055139,20130325055151,1051303250551018316,2|2013032513530363763,200,200,20130325055301,20130325055310,1051303250553018317,2|20130325135758142192,300,300,20130325055756,20130325055805,1051303250558018318,2|20130325135950789832,300,300,20130325055948,20130325060002,1051303250600018319,2|20130325140138572716,100,100,20130325060137,20130325060146,1051303250601018320,2|20130325140501403545,200,200,20130325060500,20130325060508,1051303250605018321,2|20130325140631977999,100,100,20130325060630,20130325060638,1051303250606018322,2|20130325141014823074,100,100,20130325061013,20130325061022,1051303250610018323,2|2013032514123196406,100,100,20130325061229,20130325061237,1051303250612018324,2|20130325141436628785,200,200,20130325061434,20130325061442,1051303250614018325,2|20130325141553164514,200,200,20130325061551,20130325061600,1051303250615018326,2|20130325141706874659,300,300,20130325061704,20130325061712,1051303250617018327,2|20130325141820853010,100,100,20130325061818,20130325061826,1051303250618018328,2|20130325141944172593,200,200,20130325061943,20130325061951,1051303250619018329,2|20130325143102205126,300,300,20130325063100,20130325063110,1051303250631018330,2|20130325143228636500,100,100,20130325063226,20130325063235,1051303250632018331,2|20130325143601166018,400,400,20130325063559,20130325063607,1051303250636018332,2|20130325143907579726,100,100,20130325063905,20130325063914,1051303250639018333,2|20130325144336296689,100,100,20130325064335,20130325064349,1051303250643018334,2|20130325144755945110,200,200,20130325064753,20130325064802,1051303250647018335,2|20130325145043783612,200,200,20130325065041,20130325065049,1051303250650018336,2|20130325145235458705,200,200,20130325065233,20130325065241,1051303250652018337,2|20130325145350953458,300,300,20130325065349,20130325065356,1051303250653018338,2|20130325150509502419,100,100,20130325070507,20130325070516,1051303250705018339,2|20130325151832117827,100,100,20130325071830,20130325071852,1051303250718018340,2|20130325152113538069,200,200,20130325072111,20130325072120,1051303250721018341,2|20130325152551280778,100,100,20130325072549,20130325072621,1051303250726018342,2|20130325153120790245,100,100,20130325073118,20130325073129,1051303250731018344,2|20130325153351799225,100,100,20130325073349,20130325073357,1051303250733018347,2|20130325153437838657,100,100,20130325073434,20130325073443,1051303250734018348,2|20130325153757189967,100,100,20130325073755,20130325073805,1051303250738018350,2|20130325154105339095,400,400,20130325074111,20130325074126,1051303250741018351,2|20130325154238799784,100,100,20130325074236,20130325074246,1051303250742018352,2|20130325154358802489,300,300,20130325074355,20130325074405,1051303250744018353,2|20130325154513306434,100,100,20130325074511,20130325074526,1051303250745018354,2|20130325161832186323,100,100,20130325081830,20130325082526,1051303250825018360,2|20130325162710941423,200,200,20130325082708,20130325082716,1051303250827018361,2|20130325162824656518,200,200,20130325082822,20130325082831,1051303250828018362,2|20130325162916287411,100,100,20130325082913,20130325082922,1051303250829018363,2|20130325163057222629,300,300,20130325083054,20130325083104,1051303250831018364,2|20130325163225810795,400,400,20130325083223,20130325083231,1051303250832018365,2|20130325163330732063,100,100,20130325083328,20130325083336,1051303250833018366,2|20130325163548141780,300,300,20130325083545,20130325083554,1051303250835018367,2|2013032516364086882,100,100,20130325083637,20130325083646,1051303250836018368,2|20130325164921128871,200,200,20130325084918,20130325084927,1051303250849018369,2|20130325165113447910,100,100,20130325085110,20130325085119,1051303250851018370,2|20130325165405597726,200,200,20130325085402,20130325085411,1051303250854018371,2|20130325165702296661,100,100,20130325085700,20130325085710,1051303250857018372,2|20130325170552314146,100,100,20130325090549,20130325090603,1051303250905018373,2|20130325170941690368,100,100,20130325090938,20130325090948,1051303250909018374,2|20130326105156622035,100,100,20130326025147,20130326025159,1051303260251018376,2|20130326152248944852,100,100,20130326072238,20130326072248,1051303260722018383,2|2013032604211901339,1,1,20130326082119,20130326082224,1051303260822018388,2|1482f26950ed425dbc9bd5e48ed81fd8,1000,1000,20130326091154,20130326091210,1051303260911018389,2|3d9ae52200584e54b055db3ef93d73dd,1000,1000,20130326091727,20130326091739,1051303260917018390,2|20130327095427870173,100,100,20130327015418,20130327015429,1051303270154018391,2|2013032711025715058,2000,2000,20130327030257,20130327030321,1051303270303018393,2|2013032711471137561,1000,1000,20130327034711,20130327034724,1051303270347018398,2|20130327124557790,100,100,20130327044548,20130327044609,1051303270446018399,2|2013032701122441092,1000,1000,20130327051225,20130327051324,1051303270513018400,2|2013032701184569764,1000,1000,20130327051845,20130327051857,1051303270518018401,2|2013032701334629486,2000,2000,20130327053347,20130327053356,1051303270533018402,2|2013032701531188462,3300,3300,20130327055312,20130327055338,1051303270553018403,2|2013032702051827177,1,1,20130327060518,20130327060535,1051303270605018404,2|2013032817125441820,1,1,20130328091245,20130328091326,1051303280913018412,2|20130329113559820873,1,1,20130329033551,20130329033645,1051303290336018413,2|20130329113731116551,1,1,20130329033722,20130329033745,1051303290337018414,2|20130329113933933980,1,1,20130329033925,20130329033943,1051303290339018415,2|20130329114118447433,1,1,20130329034110,20130329034322,1051303290343018416,2|20130331101134349291,1,1,20130331021129,20130331021154,1051303310211018423,2|20130331101530815802,1,1,20130331021523,20130331021535,1051303310215018424,2&partnerID=10000000029&remark=re&charset=1&signType=2&signMsg=c278136f2c7cf1d461ae0718e8bdacc2";
		 Map<String ,Object> map = new HashMap<String,Object>();
		StringTokenizer st = new StringTokenizer(str, "&");
		String resultCode="";
		while(st.hasMoreTokens()){
			String s_next = st.nextToken();
			StringTokenizer sn = new StringTokenizer(s_next,"=");			
			while(sn.hasMoreTokens()){
				String s1 = sn.nextToken();
				if(sn.hasMoreTokens()){
					String s2 = sn.nextToken();
					map.put(s1, s2);
					if(s1.equals("resultCode")){
						resultCode=s2;
					}
					if(resultCode.equals("0000") && s1.equals("queryDetails")){
//						List<QueryDetails> queryList = new ArrayList<QueryDetails>();
						Map<String,QueryDetailsXszf> qmap = new HashMap<String,QueryDetailsXszf>();
						StringTokenizer snn = new StringTokenizer(s2,"|");
						SimpleDateFormat dateformat=new SimpleDateFormat("yyyyMMddHHmmss");
						while(snn.hasMoreTokens()){
							StringTokenizer snnn = new StringTokenizer(snn.nextToken(),",");
							QueryDetailsXszf q = new QueryDetailsXszf();
							String orderId = snnn.nextToken();
							q.setOrderId(orderId);
							q.setOrderAmount(new BigDecimal(snnn.nextToken()).divide(new BigDecimal(100)).setScale(2));
							q.setPayAmount(new BigDecimal(snnn.nextToken()).divide(new BigDecimal(100)).setScale(2));
							try {
								q.setAcquiringTime(dateformat.parse(snnn.nextToken()));
								q.setCompleteTime(dateformat.parse(snnn.nextToken()));
							} catch (ParseException e) {
								// TODO Auto-generated catch block
								e.printStackTrace();
							}
							
							q.setOrderNo(snnn.nextToken());
							q.setStateCode(snnn.nextToken());
							qmap.put(orderId, q);
	//						queryList.add(q);
						}
						map.put(s1, qmap);
					}
				}
			}
		}
		
		return map; 
		
	}
	
	//交易查询Error
	public String errorCode(String str){
		String s="";
		if(str.equals("0401")){
			s="基本数据校验失败";
		}else if(str.equals("0402")){
			s="校验业务参数失败 ";
		}else if(str.equals("0403")){
			s="查询商户请求网关历史记录失败";
		}else if(str.equals("0404")){
			s="查询API-失败";
		}else if(str.equals("0405")){
			s="时间验证失败";
		}else if(str.equals("0406")){
			s="时间转换类型失败";
		}else if(str.equals("0407")){
			s="开始时间不能大于结束时间";
		}else if(str.equals("0408")){
			s="查询时间最大范围只能15天以内";
		}else if(str.equals("0409")){
			s="创建网关返回商户结果失败";
		}else if(str.equals("0410")){
			s="查询验签失败 ";
		}else if(str.equals("0411")){
			s="基本数据校验失败";
		}else{
			s="查询订单不存在 ";
		}
		return s;
	}
	
	public String resCode(String s){
		String str = resMap.get(s);
		if(str == null){
			str = "数据异常";
		}
		return str;
	}
	
	

}
